/*
 * Pronto Plugin [jQuery + CMS push state integration; Based on pjax and turbolinks]
 * @author Ben Plum
 * @version 0.1
 *
 * Copyright Â© 2012 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
 
if(jQuery)(function(c){function i(a){c.extend(d,a||{});d.$body=c("body");d.$container=c(d.container);f&&(history.replaceState({url:window.location.href,data:{title:c("head").find("title").text(),content:c(d.container).html()}},"state-"+window.location.href,window.location.href),c(window).on("popstate",j),d.$body.on("click.pronto",d.selector,k))}function k(a){var b=a.currentTarget;if(!(1<a.which||a.metaKey||a.ctrlKey||a.shiftKey||a.altKey)&&!(location.protocol!==b.protocol||location.host!==b.host)&&!(b.hash&& b.href.replace(b.hash,"")===location.href.replace(location.hash,"")||b.href===location.href+"#")){a.preventDefault();a.stopPropagation();var e=b.href;d.$container.trigger("pronto.beforeLoad");c.ajax({url:e+(e.indexOf("?")?"?pronto=true":"&pronto=true"),dataType:"json",success:function(a){g(e,a,!0)},error:function(){window.location.href=e}})}}function j(a){a=a.originalEvent.state;null!==a&&g(a.url,a.data,!1)}function g(a,b,e){c(window).scrollTop(0);void 0==typeof _gaq&&(_gaq=[]);_gaq.push(["_trackPageview"], a);document.title=b.title.replace(/&nbsp;/g," ");d.$container.trigger("pronto.onLoad").html(b.content).trigger("pronto.onRender");e&&history.pushState({url:a,data:b},"state-"+a,a)}var f=window.history&&window.history.pushState&&window.history.replaceState,d={container:"#pronto",selector:"a"},h={supported:function(){return f}};c.pronto=function(a){return h[a]?h[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"===typeof a||!a?i.apply(this,arguments):this}})(jQuery);