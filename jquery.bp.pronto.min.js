/*
 * Pronto Plugin
 * @author Ben Plum
 * @version 0.7.0
 *
 * Copyright Â© 2013 Ben Plum <mr@benplum.com>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
 
if(jQuery)(function(e){function q(a){console.log("INIT");e.extend(c,a||{});c.$body=e("body");c.$container=e(c.container);k&&(d=window.location.href,h(),f.on("popstate",r),c.$body.on("click.pronto",c.selector,s))}function s(a){var b=a.currentTarget;1<a.which||a.metaKey||a.ctrlKey||a.shiftKey||a.altKey||window.location.protocol!==link.protocol||window.location.host!==link.host||(b.hash&&b.href.replace(b.hash,"")===window.location.href.replace(location.hash,"")||b.href===window.location.href+"#"?h():(a.preventDefault(), a.stopPropagation(),d==b.href?h():l(b.href)))}function l(a){f.trigger("pronto.request");e.ajax({url:a+(-1<a.indexOf("?")?"&"+c.requestKey+"=true":"?"+c.requestKey+"=true"),dataType:"json",success:function(b){"String"==typeof b&&(b=e.parseJSON(b));n(a,b,0,!0);t++},error:function(b){window.location.href=a}})}function r(a){a=a.originalEvent.state;null!==a&&a.url!==d&&(f.trigger("pronto.request"),n(a.url,a.data,a.scroll,!1))}function n(a,b,k,l){null!==g&&(clearTimeout(g),g=null);g=setTimeout(function(){f.trigger("pronto.load"); var g=g||[];g.push(["_trackPageview"],a);h();for(var m in c.target)b.hasOwnProperty(m)&&e(c.target[m]).html(b[m]);d=a;l?history.pushState({url:d,data:b,scroll:0},"state-"+d,d):h();f.trigger("pronto.render");f.scrollTop(k)},c.requestDelay)}function h(){var a=[],b;for(b in c.target)a[b]=e(c.target[b]).html();history.replaceState({url:d,data:a,scroll:f.scrollTop()},"state-"+d,d)}var f=e(window),k=window.history&&window.history.pushState&&window.history.replaceState,d="",t=0,g=null,c={selector:"a",requestKey:"pronto", requestDelay:0,target:{title:"title",content:"#pronto"}},p={open:function(a){a&&l(a)},supported:function(){return k}};e.pronto=function(a){return p[a]?p[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!==typeof a&&a?this:q.apply(this,arguments)}})(jQuery);